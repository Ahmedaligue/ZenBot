import fs from'fs';import path from'path';import chalk from'chalk';import{fileURLToPath as a,pathToFileURL as b}from'url';import{config as c}from'../config.js';const d=path.dirname(a(import.meta.url));let e=[];export const loadPlugins=async()=>{const f=path.join(d,'../plugins'),g=fs.readdirSync(f).filter(h=>h.endsWith('.js'));console.log(chalk.cyan('\n📦 Cargando plugins...\n')),e=[];for(const h of g)try{const i=b(path.join(f,h)).href+`?update=${Date.now()}`,j=await import(i);j?.default?.command&&typeof j.default.run==='function'?(e.push({...j.default,file:h}),console.log(chalk.greenBright(`✅ ${h} cargado correctamente.`))):console.warn(chalk.yellow(`⚠️  ${h} no es un plugin válido.`))}catch(i){console.error(chalk.red(`❌ Error cargando ${h}:`),i)}console.log(chalk.magenta(`\n✅ Total de plugins cargados: ${e.length}`)),console.log(chalk.gray('────────────────────────────────────────────\n'))};const f=path.join(d,'../plugins');let g;fs.watch(f,(h,i)=>{i&&i.endsWith('.js')&&(g&&clearTimeout(g),g=setTimeout(()=>{console.log(chalk.yellow(`📝 Plugin actualizado: ${i}. Recargando...`)),loadPlugins()},300))});export const handler=async(h,i)=>{if(!h.message)return void console.log(chalk.red('[❌ ERROR] No se encontró el mensaje.'));let j='';try{const k=h.message;k.conversation?j=k.conversation:k.extendedTextMessage?.text?j=k.extendedTextMessage.text:k.imageMessage?.caption?j=k.imageMessage.caption:k.videoMessage?.caption?j=k.videoMessage.caption:(()=>{throw new Error('Tipo de mensaje no soportado.')})(),h.text=j}catch(k){return void console.log(chalk.red(`[❌ ERROR] ${k.message}`))}h.reply=l=>i.sendMessage(h.key.remoteJid,{text:l},{quoted:h});const l=c.prefix;if(!j.startsWith(l))return;const m=j.slice(l.length).trim().split(/ +/),n=m.shift()?.toLowerCase();if(!n)return;if(h.key.participant===i.user.id)return;const o=h.key.participant||h.key.remoteJid,p=h.pushName||'Desconocido',q=h.key.remoteJid.endsWith('@g.us'),r=h.key.remoteJid,s=new Date().toLocaleString('es-AR');console.log(chalk.cyanBright(`\n┏━━━━━━━━━━━━━━━━━━━━━━━━━━\n┃ 🛠️  Comando recibido\n┣━━━━━━━━━━━━━━━━━━━━━━━━━━\n┃ 👤 Usuario   : ${chalk.bold(p)}\n┃ ☎️ Número    : ${chalk.bold(o.split('@')[0])}\n┃ 💬 Chat      : ${chalk.bold(q?'Grupo':'Privado')}\n┃ 📦 Comando   : ${chalk.bold(n)}\n┃ 🕒 Fecha     : ${chalk.gray(s)}\n┗━━━━━━━━━━━━━━━━━━━━━━━━━━\n`));let t=!1;const u=async v=>h.reply&&typeof h.reply==='function'?h.reply(v):i.sendMessage(h.key.remoteJid,{text:v},{quoted:h});for(const v of e)if(v.command.includes(n)){t=!0;try{const w=q?await i.groupMetadata(r):null,x=w?.participants||[],y=o.endsWith('@s.whatsapp.net')?o:o+'@s.whatsapp.net',z=i.user?.id?.split(':')?.[0]+'@s.whatsapp.net',A=x.find(B=>B.id===z),B=x.find(C=>C.id===y)?.admin||!1,C=A?.admin||!1,D=c.owner.includes(o.split('@')[0]),E=!q;await v.run(h,{conn:i,args:m,text:m.join(' '),sender:o,isGroup:q,isAdmin:B,isBotAdmin:C,isOwner:D,isPrivado:E,userName:p,plugins:e.filter(F=>F.help&&F.tags),metadata:w,botNumber:z,botParticipant:A,groupId:r,sendReply:u,mText:h.text,mReply:h.reply,prefix:l,command:n}),console.log(chalk.green(`✅ Plugin ejecutado: ${v.file}`))}catch(w){console.error(chalk.red(`❌ Error ejecutando ${v.file}:`),w),await u('❌ Ocurrió un error al ejecutar el comando.')}}t||console.log(chalk.yellow(`🚫 Comando no encontrado: "${n}"`))};